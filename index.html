<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telemedicine Questionnaire</title>
<style>
:root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22c55e;--accent-2:#3b82f6;--danger:#ef4444;--warn:#f59e0b;--border:#374151}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:10;background:rgba(2,6,23,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.container{max-width:980px;margin:auto;padding:16px}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.spacer{flex:1}
.btn{border:1px solid var(--border);background:var(--muted);color:var(--text);padding:.6rem .9rem;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--accent);border:none;color:#041b0b}.btn.info{background:var(--accent-2);border:none;color:#06112a}
.btn.danger{background:var(--danger);border:none;color:#320808}.btn.warn{background:var(--warn);border:none;color:#2a1706}
.hidden{display:none!important}.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:16px}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(3,1fr)}
input,select,textarea{width:100%;padding:.5rem;border-radius:6px;border:1px solid var(--border);background:var(--muted);color:var(--text)}
table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid var(--border);padding:.5rem;text-align:left}tr:hover td{background:#0b1220}
</style>
</head>
<body>

<header>
  <div class="container row">
    <button id="homeBtn" class="btn">üè† Home</button>
    <span id="setCounter"></span>
    <div class="spacer"></div>
    <button id="adminBtn" class="btn info">Admin</button>
  </div>
</header>

<main class="container">
  <!-- Home -->
  <section id="view-home" class="card">
    <h2>Telemedicine Questionnaire</h2>
    <div class="grid cols-2">
      <div>
        <label>Name (optional)</label>
        <input id="nameInput">
      </div>
      <div>
        <label>Medical Specialty</label>
        <select id="specialtySelect"></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="resumeBtn" class="btn">Resume</button>
      <button id="resetBtn" class="btn danger">Reset</button>
    </div>
  </section>

  <!-- Quiz -->
  <section id="view-quiz" class="card hidden">
    <h3>Can this condition/disease be diagnosed and treated over a Telemedicine App?</h3>
    <div id="questionText" style="font-weight:bold"></div>
    <div class="row" style="margin-top:12px">
      <button id="btnYes" class="btn primary">Yes</button>
      <button id="btnNo" class="btn warn">No</button>
      <button id="btnSkip" class="btn">Skip</button>
    </div>
    <div id="noReasons" class="hidden" style="margin-top:12px">
      <label><input type="checkbox" value="physical" class="no-reason"> Need Physical Exam</label>
      <label><input type="checkbox" value="lab" class="no-reason"> Need a Lab Test</label>
      <label><input type="checkbox" value="imaging" class="no-reason"> Need Imaging</label>
    </div>
    <textarea id="noteInput" rows="2" placeholder="Add note" style="margin-top:12px"></textarea>
    <div class="row" style="margin-top:12px">
      <button id="backBtn" class="btn">‚Üê Back</button>
      <div class="spacer"></div>
      <button id="nextBtn" class="btn info">Next ‚Üí</button>
    </div>
  </section>

  <!-- Complete -->
  <section id="view-complete" class="card hidden">
    <h3>Set complete ‚úÖ</h3>
    <button id="startNextSetBtn" class="btn primary">Start next set</button>
    <button id="gotoHomeFromCompleteBtn" class="btn">Home</button>
  </section>

  <!-- Admin -->
  <section id="view-admin" class="card hidden">
    <h3>Admin Dashboard</h3>
    <div class="row">
      <button onclick="showSpecialties()" class="btn info">Manage Specialties</button>
      <button onclick="showResponses()" class="btn">View Responses</button>
      <button id="adminCloseBtn" class="btn">Close</button>
    </div>
    <div id="admin-content" style="margin-top:12px"></div>
  </section>
</main>

<script>
// helpers
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>crypto.randomUUID();
const chunk = (arr,n)=>arr.reduce((acc,_,i)=>i%n?acc:[...acc,arr.slice(i,i+n)],[]);
const shuffle = arr=>arr.sort(()=>Math.random()-.5);
const api = {
  getSpecialties:()=>fetch('/api/get-specialties').then(r=>r.json()),
  getQuestions:(id)=>fetch('/api/get-questions?specId='+id).then(r=>r.json()),
  syncUser:(token,name)=>fetch('/api/sync-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,name})}),
  saveResponse:(p)=>fetch('/api/save-response',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}),
};
let ADMIN_PW = localStorage.getItem('tmq.admin.pw') || null;

// state
const LS_KEY='tmq.user';
function getUser(){return JSON.parse(localStorage.getItem(LS_KEY)||'null')}
function saveUser(u){localStorage.setItem(LS_KEY,JSON.stringify(u))}
function initUser(){let u=getUser();if(!u){u={token:uid(),name:'',specId:null,questions:[],setIndex:0,qIndex:0};saveUser(u);}return u}

// UI nav
function show(id){['view-home','view-quiz','view-complete','view-admin'].forEach(v=>$('#'+v).classList.add('hidden'));$('#'+id).classList.remove('hidden');}

// home
async function renderHome(){
  const u=initUser();
  $('#nameInput').value=u.name;
  const sel=$('#specialtySelect');sel.innerHTML='';
  const s=await api.getSpecialties();
  (s.specialties||[]).forEach(sp=>{const o=document.createElement('option');o.value=sp.id;o.textContent=sp.name;sel.appendChild(o)});
  if(u.specId) sel.value=u.specId;
  $('#setCounter').textContent=`Set: ${u.setIndex+1}`;
}
$('#startBtn').onclick=async()=>{
  const u=initUser();
  u.name=$('#nameInput').value.trim();u.specId=$('#specialtySelect').value;
  const q=await api.getQuestions(u.specId);
  u.questions=shuffle(q.questions.map(x=>({id:x.id,text:x.text})));
  u.setIndex=0;u.qIndex=0;saveUser(u);await api.syncUser(u.token,u.name);renderQuestion();
}
$('#resumeBtn').onclick=()=>{const u=getUser();u?.specId?renderQuestion():alert('No session')}
$('#resetBtn').onclick=()=>{localStorage.removeItem(LS_KEY);location.reload()}
$('#homeBtn').onclick=()=>show('view-home');

// quiz
function renderQuestion(){
  const u=getUser();const sets=chunk(u.questions,15);const cur=sets[u.setIndex]||[];const q=cur[u.qIndex];
  if(!q){show('view-complete');return}
  $('#questionText').textContent=q.text;$('#noteInput').value='';$$('.no-reason').forEach(c=>c.checked=false);$('#noReasons').classList.add('hidden');show('view-quiz');
}
async function saveAnswer(ans){
  const u=getUser();const sets=chunk(u.questions,15);const cur=sets[u.setIndex];const q=cur[u.qIndex];
  const reasons=ans==='no' ? $$('.no-reason').filter(c=>c.checked).map(c=>c.value) : [];
  await api.saveResponse({token:u.token,specId:u.specId,questionId:q.id,questionText:q.text,answer:ans,reasons,note:$('#noteInput').value});
  u.qIndex++;saveUser(u);
}
$('#btnYes').onclick=async()=>{await saveAnswer('yes');renderQuestion()}
$('#btnNo').onclick=()=>$('#noReasons').classList.remove('hidden');
$('#btnSkip').onclick=async()=>{await saveAnswer('skip');renderQuestion()}
$('#nextBtn').onclick=async()=>{if(!$('#noReasons').classList.contains('hidden')) await saveAnswer('no');renderQuestion()}
$('#backBtn').onclick=()=>{const u=getUser();if(u.qIndex>0){u.qIndex--;saveUser(u);renderQuestion()}else show('view-home')}

// complete
$('#startNextSetBtn').onclick=()=>{const u=getUser();u.setIndex++;u.qIndex=0;saveUser(u);renderQuestion()}
$('#gotoHomeFromCompleteBtn').onclick=()=>show('view-home')

// admin
$('#adminBtn').onclick=async()=>{
  if(!ADMIN_PW){
    const pw=prompt('Admin password');if(!pw)return;
    const res=await fetch('/api/admin-list-responses',{headers:{'X-Admin-Password':pw}});
    if(!res.ok){alert('Invalid');return}ADMIN_PW=pw;localStorage.setItem('tmq.admin.pw',pw);
  }
  showSpecialties();show('view-admin');
}
$('#adminCloseBtn').onclick=()=>show('view-home');

function h(tag,attrs={},children=[]){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k.startsWith('on'))e.addEventListener(k.slice(2),v);else e.setAttribute(k,v)});(Array.isArray(children)?children:[children]).forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c));return e}

async function showSpecialties(){
  const root=$('#admin-content');root.innerHTML='';
  const inp=h('input',{placeholder:'New specialty'});const add=h('button',{class:'btn',onclick:async()=>{
    await fetch('/api/admin-upsert-specialty',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Password':ADMIN_PW},body:JSON.stringify({name:inp.value})});
    showSpecialties();
  }},'Add');root.appendChild(h('div',{class:'row'},[inp,add]));
  const t=h('table',{},[h('thead',{},h('tr',{},[h('th',{},'Name'),h('th',{},'Q Count')])),h('tbody')]);root.appendChild(t);
  const s=await api.getSpecialties();const tb=t.querySelector('tbody');
  for(const sp of s.specialties){
    const q=await api.getQuestions(sp.id);
    tb.appendChild(h('tr',{},[h('td',{},sp.name),h('td',{},String(q.questions.length))]));
  }
}

async function showResponses(){
  const root=$('#admin-content');root.innerHTML='';
  const res=await fetch('/api/admin-list-responses',{headers:{'X-Admin-Password':ADMIN_PW}});if(!res.ok){root.textContent='Failed';return}
  const d=await res.json();const t=h('table',{},[h('thead',{},h('tr',{},['Token','Name','Spec','Question','Answer','Reasons','Note','Time'].map(x=>h('th',{},x)))),h('tbody')]);root.appendChild(t);
  const tb=t.querySelector('tbody');(d.rows||[]).forEach(r=>{tb.appendChild(h('tr',{},[h('td',{},r.token.slice(0,8)+'‚Ä¶'),h('td',{},r.name),h('td',{},r.spec_id),h('td',{},r.question_text),h('td',{},r.answer),h('td',{},(r.reasons||[]).join('|')),h('td',{},r.note),h('td',{},r.created_at)]))});
}

renderHome();
</script>
</body>
</html>
